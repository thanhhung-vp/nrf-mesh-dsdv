# BLE Mesh DSDV Routing System - Flow Diagram & Packet Structures

## ğŸ“Š System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BLE Mesh DSDV Network Topology                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚   Node 0x0001 â—„â”€â”€â”€â”€â”€â”€â–º Node 0x0002 â—„â”€â”€â”€â”€â”€â”€â–º Node 0x0003            â”‚
â”‚       â”‚                     â”‚                     â”‚                  â”‚
â”‚       â”‚                     â”‚                     â”‚                  â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Node 0x0004 â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                            â”‚                                          â”‚
â”‚                            â”‚                                          â”‚
â”‚                     Node 0x0005                                       â”‚
â”‚                                                                       â”‚
â”‚  Legend:                                                              â”‚
â”‚  â—„â”€â”€â”€â”€â–º : Bidirectional BLE Mesh communication                      â”‚
â”‚  Each node maintains routing table to all other nodes                â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Protocol Packet Flow Timeline

### Phase 1: Network Initialization & Discovery

```
Time: 0s - 10s (Network boot-up)

Node 0x0001                Node 0x0002                Node 0x0003
    â”‚                          â”‚                          â”‚
    â”‚â”€â”€â”€[HELLO]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                          â”‚
    â”‚   5s interval             â”‚                          â”‚
    â”‚                          â”‚â”€â”€â”€[HELLO]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
    â”‚                          â”‚   5s interval             â”‚
    â”‚                          â”‚                          â”‚
    â”‚â—„â”€â”€[HELLO]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
    â”‚   (RSSI measured)         â”‚                          â”‚
    â”‚                          â”‚â—„â”€â”€[HELLO]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                          â”‚   (RSSI measured)         â”‚
    â”‚                          â”‚                          â”‚
    â””â”€â–º Routing Table:         â””â”€â–º Routing Table:         â””â”€â–º Routing Table:
        0x0002 via 0x0002          0x0001 via 0x0001          0x0002 via 0x0002
        (1 hop, RSSI: -65)         (1 hop, RSSI: -65)         (1 hop, RSSI: -70)
```

### Phase 2: Routing Table Exchange

```
Time: 3s - 18s (Periodic updates every ~15s)

Node 0x0001                Node 0x0002                Node 0x0003
    â”‚                          â”‚                          â”‚
    â”‚â”€â”€â”€[UPDATE]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                          â”‚
    â”‚   num_entries: 1          â”‚                          â”‚
    â”‚   - 0x0002 (1 hop)        â”‚ (excludes self)          â”‚
    â”‚                          â”‚                          â”‚
    â”‚                          â”‚â”€â”€â”€[UPDATE]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
    â”‚                          â”‚   num_entries: 2          â”‚
    â”‚                          â”‚   - 0x0001 (1 hop)        â”‚
    â”‚                          â”‚   - 0x0003 (1 hop)        â”‚
    â”‚                          â”‚                          â”‚
    â”‚â—„â”€â”€[UPDATE]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
    â”‚   Learn: 0x0003 via       â”‚                          â”‚
    â”‚   0x0002 (2 hops)         â”‚                          â”‚
    â”‚                          â”‚                          â”‚
    â””â”€â–º Routing Table:         â””â”€â–º Routing Table:         â””â”€â–º Routing Table:
        0x0002 (1 hop, -65)        0x0001 (1 hop, -65)        0x0001 (2 hop, -72)
        0x0003 (2 hop, -72)        0x0003 (1 hop, -70)        0x0002 (1 hop, -70)
```

### Phase 3: Data Transmission with Metrics

```
Time: User sends message

Scenario: Node 0x0001 sends data to Node 0x0003 via Node 0x0002

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node 0x0001 â”‚          â”‚ Node 0x0002 â”‚          â”‚ Node 0x0003 â”‚
â”‚  (Source)   â”‚          â”‚   (Relay)   â”‚          â”‚ (Destination)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                        â”‚                        â”‚
       â”‚ 1. Send DATA packet    â”‚                        â”‚
       â”‚    with source metrics â”‚                        â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                        â”‚
       â”‚                        â”‚                        â”‚
       â”‚                        â”‚ 2. Forward DATA packet â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
       â”‚                        â”‚                        â”‚
       â”‚                        â”‚ 3. Send RELAY_METRICS  â”‚
       â”‚                        â”‚    (own metrics)       â”‚
       â”‚                        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
       â”‚                        â”‚                        â”‚
       â”‚                        â”‚ 4. Process & store:    â”‚
       â”‚                        â”‚    - Source metrics    â”‚
       â”‚                        â”‚    - Relay metrics     â”‚
       â”‚                        â”‚    - Calculate RTT     â”‚
       â”‚                        â”‚                        â”‚
       â”‚                                                  â”‚
       â”‚ 5. Optional: METRICS_ACK (for RTT calculation)  â”‚
       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
       â”‚                                                  â”‚
       â”‚                                                  â”‚
```

### Phase 4: Network Monitoring & Analysis

```
Time: Continuous monitoring

User Shell Command: "chat relay_metrics"

Terminal Output:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ === RELAY NODE METRICS CACHE ===                          â”‚
â”‚                                                            â”‚
â”‚ [Entry 1] Relay: 0x0002 (for src=0x0001, seq=15)         â”‚
â”‚   Battery: 87%, Neighbors: 3, Weak: 0%, Congestion: 12â€°  â”‚
â”‚   Measured: 5.2s ago, Count: 3                            â”‚
â”‚   Neighbors:                                               â”‚
â”‚     â†’ 0x0001: -65 dBm                                     â”‚
â”‚     â†’ 0x0003: -70 dBm                                     â”‚
â”‚     â†’ 0x0004: -68 dBm                                     â”‚
â”‚                                                            â”‚
â”‚ [Entry 2] Relay: 0x0004 (for src=0x0001, seq=18)         â”‚
â”‚   Battery: 45%, Neighbors: 2, Weak: 50%, Congestion: 8â€°  â”‚
â”‚   Measured: 12.8s ago, Count: 1                           â”‚
â”‚   Neighbors:                                               â”‚
â”‚     â†’ 0x0001: -88 dBm (WEAK)                              â”‚
â”‚     â†’ 0x0002: -72 dBm                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ Packet Structure Details

### 1. DSDV_HELLO Packet (8 bytes)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DSDV_HELLO Packet - Neighbor Discovery             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Opcode: 0x12 (BT_MESH_CHAT_CLI_OP_DSDV_HELLO)    â”‚
â”‚  Purpose: Broadcast every ~5 seconds               â”‚
â”‚  Range: 1-hop neighbors only                       â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Field          â”‚ Type    â”‚ Size â”‚ Value     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ src            â”‚ uint16  â”‚ 2 B  â”‚ 0x0001   â”‚  â”‚
â”‚  â”‚ seq_num        â”‚ uint32  â”‚ 4 B  â”‚ 1234     â”‚  â”‚
â”‚  â”‚ flags          â”‚ uint16  â”‚ 2 B  â”‚ 0x0000   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                     â”‚
â”‚  Total Size: 8 bytes                                â”‚
â”‚                                                     â”‚
â”‚  Receiver Actions:                                  â”‚
â”‚  âœ“ Measure RSSI from packet reception              â”‚
â”‚  âœ“ Create/update 1-hop route to sender             â”‚
â”‚  âœ“ Update neighbor_rssi[] array with EWMA          â”‚
â”‚  âœ“ Detect lost neighbors (timeout 45s)             â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Timing:
  Initial: 1.5s Â± 0.5s (random jitter)
  Periodic: 5s Â± 0.5s (random jitter)
  Purpose: Avoid collision in synchronized networks
```

### 2. DSDV_UPDATE Packet (Variable Size)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DSDV_UPDATE Packet - Routing Table Exchange        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Opcode: 0x13 (BT_MESH_CHAT_CLI_OP_DSDV_UPDATE)   â”‚
â”‚  Purpose: Share routing info every ~15 seconds     â”‚
â”‚  Range: 1-hop broadcast (not relayed)              â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEADER (4 bytes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ src            â”‚ uint16  â”‚ 2 B  â”‚ 0x0002    â”‚ â”‚
â”‚  â”‚ num_entries    â”‚ uint8   â”‚ 1 B  â”‚ 2         â”‚ â”‚
â”‚  â”‚ flags          â”‚ uint8   â”‚ 1 B  â”‚ 0x00      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                     â”‚
â”‚  Note: num_entries = count of valid routes         â”‚
â”‚        (excludes self, max 16 entries)             â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ENTRY 1 (8 bytes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ dest           â”‚ uint16  â”‚ 2 B  â”‚ 0x0001    â”‚ â”‚
â”‚  â”‚ next_hop       â”‚ uint16  â”‚ 2 B  â”‚ 0x0001    â”‚ â”‚
â”‚  â”‚ hop_count      â”‚ uint8   â”‚ 1 B  â”‚ 1         â”‚ â”‚
â”‚  â”‚ flags          â”‚ uint8   â”‚ 1 B  â”‚ 0x00      â”‚ â”‚
â”‚  â”‚ seq_num        â”‚ uint32  â”‚ 4 B  â”‚ 5678      â”‚ â”‚
â”‚  â”‚ last_update    â”‚ uint32  â”‚ 4 B  â”‚ 148000    â”‚ â”‚
â”‚  â”‚ rssi           â”‚ int8    â”‚ 1 B  â”‚ -65       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ENTRY 2 (8 bytes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ dest           â”‚ uint16  â”‚ 2 B  â”‚ 0x0003    â”‚ â”‚
â”‚  â”‚ next_hop       â”‚ uint16  â”‚ 2 B  â”‚ 0x0003    â”‚ â”‚
â”‚  â”‚ hop_count      â”‚ uint8   â”‚ 1 B  â”‚ 1         â”‚ â”‚
â”‚  â”‚ flags          â”‚ uint8   â”‚ 1 B  â”‚ 0x00      â”‚ â”‚
â”‚  â”‚ seq_num        â”‚ uint32  â”‚ 4 B  â”‚ 9101      â”‚ â”‚
â”‚  â”‚ last_update    â”‚ uint32  â”‚ 4 B  â”‚ 147500    â”‚ â”‚
â”‚  â”‚ rssi           â”‚ int8    â”‚ 1 B  â”‚ -72       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                     â”‚
â”‚  Total Size: 4 + (num_entries Ã— 8) bytes           â”‚
â”‚  Example: 4 + (2 Ã— 8) = 20 bytes                   â”‚
â”‚  Range: 4-260 bytes (0-32 entries max)             â”‚
â”‚                                                     â”‚
â”‚  Receiver Actions:                                  â”‚
â”‚  âœ“ Parse each route entry                          â”‚
â”‚  âœ“ Update routing table if:                        â”‚
â”‚    - Higher seq_num (fresher route)                â”‚
â”‚    - Same seq_num but better metric                â”‚
â”‚  âœ“ Calculate route metric: 0.7Ã—RSSI + 0.3Ã—hop     â”‚
â”‚  âœ“ Delete stale routes (timeout 45s)               â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Timing:
  Initial: 3s Â± 1s (random jitter)
  Periodic: 15s Â± 1s (random jitter)
  Route Timeout: 45s (3Ã— update interval)
  
Max Coverage:
  UPDATE packet can advertise up to 32 routes
  Suitable for networks up to ~32 nodes in single packet
```

### 3. DSDV_DATA Packet (Variable Size, Max 128 bytes)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DSDV_DATA Packet - End-to-End Data with Metrics               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Opcode: 0x14 (BT_MESH_CHAT_CLI_OP_DSDV_DATA)                 â”‚
â”‚  Purpose: Deliver user data + network metrics                  â”‚
â”‚  Range: Multi-hop routed delivery                              â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEADER (28 bytes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ src               â”‚ uint16  â”‚ 2 B  â”‚ 0x0001             â”‚ â”‚
â”‚  â”‚ dest              â”‚ uint16  â”‚ 2 B  â”‚ 0x0003             â”‚ â”‚
â”‚  â”‚ seq_num           â”‚ uint32  â”‚ 4 B  â”‚ 15                 â”‚ â”‚
â”‚  â”‚ hop_count         â”‚ uint8   â”‚ 1 B  â”‚ 0 (incremented)    â”‚ â”‚
â”‚  â”‚ path_len          â”‚ uint8   â”‚ 1 B  â”‚ 0 (incremented)    â”‚ â”‚
â”‚  â”‚ path_nodes[8]     â”‚ uint16[]â”‚ 16 B â”‚ [0x0001, 0x0002..] â”‚ â”‚
â”‚  â”‚ collect_relay_..  â”‚ uint8   â”‚ 1 B  â”‚ 1 (enable)         â”‚ â”‚
â”‚  â”‚ (padding)         â”‚         â”‚ 1 B  â”‚                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ SOURCE METRICS (40 bytes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ src_addr          â”‚ uint16  â”‚ 2 B  â”‚ 0x0001           â”‚   â”‚
â”‚  â”‚ about_addr        â”‚ uint16  â”‚ 2 B  â”‚ 0x0003           â”‚   â”‚
â”‚  â”‚ timestamp         â”‚ uint32  â”‚ 4 B  â”‚ 152340 ms        â”‚   â”‚
â”‚  â”‚ battery_pct       â”‚ uint8   â”‚ 1 B  â”‚ 87%              â”‚   â”‚
â”‚  â”‚ rssi_dbm          â”‚ int8    â”‚ 1 B  â”‚ -72 dBm          â”‚   â”‚
â”‚  â”‚ congestion        â”‚ uint16  â”‚ 2 B  â”‚ 12â€°              â”‚   â”‚
â”‚  â”‚ initial_ttl       â”‚ uint8   â”‚ 1 B  â”‚ 5                â”‚   â”‚
â”‚  â”‚ hop_count         â”‚ uint8   â”‚ 1 B  â”‚ 2                â”‚   â”‚
â”‚  â”‚ request_ack       â”‚ uint8   â”‚ 1 B  â”‚ 1 (yes)          â”‚   â”‚
â”‚  â”‚ neighbor_count    â”‚ uint8   â”‚ 1 B  â”‚ 3                â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚  â”‚ neighbor_rssi[0]  â”‚ struct  â”‚ 3 B  â”‚ addr=0x0002      â”‚   â”‚
â”‚  â”‚                   â”‚         â”‚      â”‚ rssi=-65 dBm     â”‚   â”‚
â”‚  â”‚ neighbor_rssi[1]  â”‚ struct  â”‚ 3 B  â”‚ addr=0x0004      â”‚   â”‚
â”‚  â”‚                   â”‚         â”‚      â”‚ rssi=-68 dBm     â”‚   â”‚
â”‚  â”‚ neighbor_rssi[2]  â”‚ struct  â”‚ 3 B  â”‚ addr=0x0005      â”‚   â”‚
â”‚  â”‚                   â”‚         â”‚      â”‚ rssi=-88 dBm     â”‚   â”‚
â”‚  â”‚ neighbor_rssi[3-7]â”‚         â”‚ 15 B â”‚ (unused)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Total Size: 28 + 40 = 68 bytes (minimum)                      â”‚
â”‚  Max Size: 128 bytes (with payload data)                       â”‚
â”‚                                                                 â”‚
â”‚  Relay Node Actions:                                            â”‚
â”‚  âœ“ Increment hop_count                                          â”‚
â”‚  âœ“ Append own address to path_nodes[]                          â”‚
â”‚  âœ“ If collect_relay_metrics=1:                                 â”‚
â”‚    â†’ Send separate RELAY_METRICS packet to destination         â”‚
â”‚  âœ“ Forward packet to next_hop per routing table                â”‚
â”‚                                                                 â”‚
â”‚  Destination Actions:                                           â”‚
â”‚  âœ“ Store source metrics to metrics_cache[16]                   â”‚
â”‚  âœ“ Store relay metrics to relay_cache[16] (from RELAY_METRICS) â”‚
â”‚  âœ“ Calculate weak_node_pct from neighbor_rssi[]                â”‚
â”‚  âœ“ Display formatted metrics table                             â”‚
â”‚  âœ“ If request_ack=1: Send METRICS_ACK for RTT                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. RELAY_METRICS Packet (48 bytes)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RELAY_METRICS Packet - Intermediate Node Metrics              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Opcode: 0x15 (BT_MESH_CHAT_CLI_OP_RELAY_METRICS)             â”‚
â”‚  Purpose: Send relay node's own metrics to destination         â”‚
â”‚  Trigger: When relaying DATA packet with collect_relay=1      â”‚
â”‚  Range: Direct to destination (not relayed)                    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CORRELATION INFO (8 bytes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ original_src      â”‚ uint16  â”‚ 2 B  â”‚ 0x0001          â”‚   â”‚
â”‚  â”‚ original_seq      â”‚ uint32  â”‚ 4 B  â”‚ 15              â”‚   â”‚
â”‚  â”‚ relay_addr        â”‚ uint16  â”‚ 2 B  â”‚ 0x0002          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ RELAY NODE METRICS (40 bytes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ src_addr          â”‚ uint16  â”‚ 2 B  â”‚ 0x0002           â”‚   â”‚
â”‚  â”‚ about_addr        â”‚ uint16  â”‚ 2 B  â”‚ 0x0003           â”‚   â”‚
â”‚  â”‚ timestamp         â”‚ uint32  â”‚ 4 B  â”‚ 152345 ms        â”‚   â”‚
â”‚  â”‚ battery_pct       â”‚ uint8   â”‚ 1 B  â”‚ 65%              â”‚   â”‚
â”‚  â”‚ rssi_dbm          â”‚ int8    â”‚ 1 B  â”‚ -70 dBm          â”‚   â”‚
â”‚  â”‚ congestion        â”‚ uint16  â”‚ 2 B  â”‚ 8â€°               â”‚   â”‚
â”‚  â”‚ initial_ttl       â”‚ uint8   â”‚ 1 B  â”‚ 5                â”‚   â”‚
â”‚  â”‚ hop_count         â”‚ uint8   â”‚ 1 B  â”‚ 1                â”‚   â”‚
â”‚  â”‚ request_ack       â”‚ uint8   â”‚ 1 B  â”‚ 0                â”‚   â”‚
â”‚  â”‚ neighbor_count    â”‚ uint8   â”‚ 1 B  â”‚ 4                â”‚   â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â”‚
â”‚  â”‚ neighbor_rssi[0]  â”‚ struct  â”‚ 3 B  â”‚ addr=0x0001      â”‚   â”‚
â”‚  â”‚                   â”‚         â”‚      â”‚ rssi=-65 dBm     â”‚   â”‚
â”‚  â”‚ neighbor_rssi[1]  â”‚ struct  â”‚ 3 B  â”‚ addr=0x0003      â”‚   â”‚
â”‚  â”‚                   â”‚         â”‚      â”‚ rssi=-70 dBm     â”‚   â”‚
â”‚  â”‚ neighbor_rssi[2]  â”‚ struct  â”‚ 3 B  â”‚ addr=0x0004      â”‚   â”‚
â”‚  â”‚                   â”‚         â”‚      â”‚ rssi=-68 dBm     â”‚   â”‚
â”‚  â”‚ neighbor_rssi[3]  â”‚ struct  â”‚ 3 B  â”‚ addr=0x0005      â”‚   â”‚
â”‚  â”‚                   â”‚         â”‚      â”‚ rssi=-75 dBm     â”‚   â”‚
â”‚  â”‚ neighbor_rssi[4-7]â”‚         â”‚ 12 B â”‚ (unused)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  Total Size: 8 + 40 = 48 bytes                                 â”‚
â”‚                                                                 â”‚
â”‚  Why Separate Packet?                                           â”‚
â”‚  â€¢ Relay nodes can't modify DATA packet (breaks signature)     â”‚
â”‚  â€¢ Destination needs metrics from ALL nodes (not just source)  â”‚
â”‚  â€¢ Enables complete network topology visibility                â”‚
â”‚                                                                 â”‚
â”‚  Destination Actions:                                           â”‚
â”‚  âœ“ Match packet using original_src + original_seq              â”‚
â”‚  âœ“ Store to relay_cache[16] with LRU replacement               â”‚
â”‚  âœ“ Calculate weak_node_pct from relay's neighbor_rssi[]        â”‚
â”‚  âœ“ Display formatted metrics table                             â”‚
â”‚  âœ“ Enable post-analysis of relay behavior                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Flow Example:
  1. Node 0x0001 sends DATA(collect_relay=1) to 0x0003 via 0x0002
  2. Node 0x0002 forwards DATA to 0x0003
  3. Node 0x0002 sends RELAY_METRICS directly to 0x0003
  4. Node 0x0003 receives both packets, correlates by src+seq
```

### 5. METRICS_ACK Packet (8 bytes)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ METRICS_ACK Packet - RTT Measurement               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Opcode: 0x0F (BT_MESH_CHAT_CLI_OP_METRICS_ACK)   â”‚
â”‚  Purpose: Enable RTT calculation                   â”‚
â”‚  Trigger: When DATA packet has request_ack=1       â”‚
â”‚  Range: Multi-hop routed back to source            â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Field              â”‚ Type    â”‚ Size â”‚ Value â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ src_addr           â”‚ uint16  â”‚ 2 B  â”‚ 0x0001â”‚  â”‚
â”‚  â”‚ original_timestamp â”‚ uint32  â”‚ 4 B  â”‚ 152340â”‚  â”‚
â”‚  â”‚ padding            â”‚ uint16  â”‚ 2 B  â”‚ 0x0000â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                     â”‚
â”‚  Total Size: 8 bytes                                â”‚
â”‚                                                     â”‚
â”‚  Source Actions:                                    â”‚
â”‚  âœ“ RTT = current_time - original_timestamp         â”‚
â”‚  âœ“ Store RTT to metrics_cache[] for analysis       â”‚
â”‚  âœ“ Display: "ACK received from 0x0003, RTT=25ms"   â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6. Additional Packet Types (Query/Response)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STRUCTURE_REQUEST Packet (8 bytes)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Opcode: 0x16                                       â”‚
â”‚  Purpose: Request remote node's routing table      â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ requester_addr  â”‚ uint16  â”‚ 2 B  â”‚ 0x0001  â”‚ â”‚
â”‚  â”‚ request_seq     â”‚ uint32  â”‚ 4 B  â”‚ 42      â”‚ â”‚
â”‚  â”‚ padding         â”‚ uint16  â”‚ 2 B  â”‚ 0x0000  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                     â”‚
â”‚  Response: Target node prints routing table to log â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONVERGENCE_REQUEST Packet (8 bytes)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Opcode: 0x17                                       â”‚
â”‚  Purpose: Query convergence statistics             â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ requester_addr  â”‚ uint16  â”‚ 2 B  â”‚ 0x0001  â”‚ â”‚
â”‚  â”‚ request_seq     â”‚ uint32  â”‚ 4 B  â”‚ 43      â”‚ â”‚
â”‚  â”‚ padding         â”‚ uint16  â”‚ 2 B  â”‚ 0x0000  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                     â”‚
â”‚  Response: Target node prints convergence stats    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Detailed Packet Flow Scenarios

### Scenario 1: Complete Data Flow with Relay Metrics

```
Network Topology:
  Node A (0x0001) â”€â”€â”€â”€â–º Node B (0x0002) â”€â”€â”€â”€â–º Node C (0x0003)

Step-by-Step Flow:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Node A sends DATA packet                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Node A:
  â€¢ Looks up route: dest=0x0003, next_hop=0x0002
  â€¢ Collects own metrics (battery, neighbor RSSI, congestion)
  â€¢ Creates DATA packet:
      src=0x0001, dest=0x0003, seq=15
      hop_count=0, path_len=0
      collect_relay_metrics=1
      metrics.src_addr=0x0001
      metrics.neighbor_count=2
      metrics.neighbor_rssi[] = [
        {0x0002, -65 dBm},
        {0x0004, -68 dBm}
      ]
  â€¢ Sends to next_hop=0x0002

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Node B receives and forwards DATA                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Node B:
  â€¢ Receives DATA from 0x0001
  â€¢ Checks: dest=0x0003 â‰  self â†’ forward
  â€¢ Increments hop_count=1
  â€¢ Appends path_nodes[0]=0x0002
  â€¢ Looks up route: dest=0x0003, next_hop=0x0003
  â€¢ Forwards DATA to next_hop=0x0003

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Node B sends RELAY_METRICS (parallel to forwarding)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Node B:
  â€¢ Sees collect_relay_metrics=1 in DATA packet
  â€¢ Collects own metrics:
      battery=65%, neighbor_count=4
      neighbor_rssi[] = [
        {0x0001, -65 dBm},
        {0x0003, -70 dBm},
        {0x0004, -68 dBm},
        {0x0005, -75 dBm}
      ]
  â€¢ Creates RELAY_METRICS packet:
      original_src=0x0001
      original_seq=15
      relay_addr=0x0002
      relay_metrics.src_addr=0x0002
  â€¢ Sends DIRECTLY to dest=0x0003 (not relayed)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Node C receives and processes both packets              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Node C (receives 2 packets):

Packet 1: DATA from Node A via Node B
  â€¢ Parses source metrics:
      src=0x0001, battery=87%, neighbor_count=2
      neighbor_rssi[] = [0x0002:-65, 0x0004:-68]
      weak_node_pct = 0% (no RSSI < -80)
  â€¢ Stores to metrics_cache[16]
  â€¢ Displays: "=== SOURCE NODE METRICS ==="

Packet 2: RELAY_METRICS from Node B
  â€¢ Correlates: original_src=0x0001, original_seq=15 â†’ matches DATA
  â€¢ Parses relay metrics:
      relay=0x0002, battery=65%, neighbor_count=4
      neighbor_rssi[] = [0x0001:-65, 0x0003:-70, 0x0004:-68, 0x0005:-75]
      weak_node_pct = 0%
  â€¢ Stores to relay_cache[16]
  â€¢ Displays: "=== RELAY NODE METRICS ==="

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: Node C sends METRICS_ACK (if requested)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Node C:
  â€¢ Checks DATA.metrics.request_ack=1
  â€¢ Creates METRICS_ACK:
      src_addr=0x0001 (echo back)
      original_timestamp=152340 (echo back)
  â€¢ Looks up route: dest=0x0001, next_hop=0x0002
  â€¢ Sends ACK back via routing

Node A (receives ACK):
  â€¢ RTT = current_time - original_timestamp
  â€¢ Example: RTT = 152365 - 152340 = 25 ms
  â€¢ Updates metrics_cache[] with RTT
  â€¢ Displays: "ACK from 0x0003, RTT=25ms"
```

### Scenario 2: Route Selection with Multiple Options

```
Network Topology:
         0x0002 (RSSI -65, 2 hops)
        /                            \
  0x0001                              0x0005
        \                            /
         0x0003 (RSSI -88 WEAK, 1 hop)

Question: Which route should 0x0001 choose to reach 0x0005?

Route Option Analysis:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Option 1: 0x0001 â†’ 0x0002 â†’ 0x0005                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hop 1: 0x0001 â†’ 0x0002, RSSI = -65 dBm                   â”‚
â”‚ Hop 2: 0x0002 â†’ 0x0005, RSSI = -70 dBm                   â”‚
â”‚ Total hops: 2                                              â”‚
â”‚ Metric: 0.7 Ã— (-65) + 0.3 Ã— 2 = -45.5 + 0.6 = -44.9      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Option 2: 0x0001 â†’ 0x0003 â†’ 0x0005                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Hop 1: 0x0001 â†’ 0x0003, RSSI = -88 dBm (WEAK)            â”‚
â”‚ Hop 2: 0x0003 â†’ 0x0005, RSSI = -75 dBm                   â”‚
â”‚ Total hops: 2                                              â”‚
â”‚ Metric: 0.7 Ã— (-88) + 0.3 Ã— 2 = -61.6 + 0.6 = -61.0      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Decision:
  âœ“ Option 1 selected (metric -44.9 > -61.0)
  â€¢ Better RSSI outweighs same hop count
  â€¢ Avoids weak link to 0x0003
  â€¢ More reliable delivery expected
```

### Scenario 3: Network Convergence After Node Failure

```
Initial Network:
  Node A â—„â”€â”€â–º Node B â—„â”€â”€â–º Node C
            (active)

Event: Node B goes offline at t=100s

Timeline:

t=100s: Node B fails
  â€¢ Stops sending HELLO/UPDATE packets

t=100-145s: Grace period
  â€¢ Node A and C keep stale routes to B
  â€¢ Route timeout = 45s (3 Ã— UPDATE interval)

t=145s: Route timeout triggered
  â€¢ Node A: Route to B marked INVALID (timeout)
  â€¢ Node C: Route to B marked INVALID (timeout)
  â€¢ Routes through B (e.g., Aâ†’Bâ†’C) also invalidated

t=145s: Route recalculation
  â€¢ Node A updates routing table
  â€¢ Node C updates routing table
  â€¢ If alternative path exists (e.g., Aâ†’Dâ†’C):
      â†’ Route converges to new path
  â€¢ If no alternative:
      â†’ Destination marked UNREACHABLE

Convergence Metrics:
  â€¢ Detection time: 45s (route timeout)
  â€¢ Convergence time: 45s + 15s = 60s (+ next UPDATE)
  â€¢ Total downtime: ~60s for 3-hop network

Improvement with Faster HELLO:
  â€¢ Current: HELLO every 5s, UPDATE every 15s
  â€¢ Alternative: HELLO every 1s, UPDATE every 3s
  â€¢ Faster detection, but higher bandwidth usage
```

## ğŸ“Š Data Storage Architecture

### 1. Routing Table (Per Node)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ routing_table[MAX_DSDV_ROUTES] = 32 entries                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Each entry (struct dsdv_route_entry):                      â”‚
â”‚   â€¢ dest: Destination address                              â”‚
â”‚   â€¢ next_hop: Next hop to reach dest                       â”‚
â”‚   â€¢ hop_count: Number of hops                              â”‚
â”‚   â€¢ seq_num: Sequence number from destination              â”‚
â”‚   â€¢ last_update_time: Last update timestamp                â”‚
â”‚   â€¢ rssi: RSSI to next_hop                                 â”‚
â”‚                                                             â”‚
â”‚ Update Triggers:                                            â”‚
â”‚   â€¢ HELLO packet â†’ 1-hop routes                            â”‚
â”‚   â€¢ UPDATE packet â†’ Multi-hop routes                       â”‚
â”‚   â€¢ Higher seq_num or better metric                        â”‚
â”‚                                                             â”‚
â”‚ Timeout: 45 seconds (3 Ã— UPDATE_INTERVAL)                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Metrics Cache (Destination Node)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ metrics_cache[16] - Source Node Metrics                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Stores complete metrics from DATA packet source:           â”‚
â”‚   â€¢ bt_mesh_network_metrics struct (40 bytes)              â”‚
â”‚   â€¢ RTT (if ACK received)                                  â”‚
â”‚   â€¢ Storage timestamp                                      â”‚
â”‚                                                             â”‚
â”‚ Indexed by: src_addr                                       â”‚
â”‚ Replacement: Overwrite when same src sends new packet      â”‚
â”‚                                                             â”‚
â”‚ Usage:                                                      â”‚
â”‚   â€¢ Shell command: "chat routes" â†’ display summary         â”‚
â”‚   â€¢ Post-analysis of network performance                   â”‚
â”‚   â€¢ Identify problematic source nodes                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ relay_cache[16] - Relay Node Metrics                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Stores metrics from RELAY_METRICS packets:                 â”‚
â”‚   â€¢ relay_addr: Which relay sent metrics                   â”‚
â”‚   â€¢ original_src + original_seq: Correlation               â”‚
â”‚   â€¢ bt_mesh_network_metrics struct (40 bytes)              â”‚
â”‚   â€¢ measurement_count: Times relay observed                â”‚
â”‚   â€¢ timestamp: When last received                          â”‚
â”‚                                                             â”‚
â”‚ Indexed by: relay_addr                                     â”‚
â”‚ Replacement: LRU (Least Recently Used)                     â”‚
â”‚                                                             â”‚
â”‚ Usage:                                                      â”‚
â”‚   â€¢ Shell command: "chat relay_metrics"                    â”‚
â”‚   â€¢ Analyze relay node behavior                            â”‚
â”‚   â€¢ Detect relay bottlenecks or failures                   â”‚
â”‚   â€¢ Complete network topology map                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Neighbor Tracking (Per Node)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ neighbor_rssi[MAX_RSSI_NEIGHBORS=16]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Local tracking of all 1-hop neighbors:                     â”‚
â”‚                                                             â”‚
â”‚ struct neighbor_rssi_info {                                â”‚
â”‚     uint16_t addr;           // Neighbor address           â”‚
â”‚     int8_t rssi;             // Current RSSI (EWMA)        â”‚
â”‚     uint32_t last_update;    // Timestamp                  â”‚
â”‚ }                                                           â”‚
â”‚                                                             â”‚
â”‚ Update Trigger: HELLO packet reception                     â”‚
â”‚ RSSI Smoothing: EWMA (Exponential Weighted Moving Average) â”‚
â”‚   new_rssi = 0.7 Ã— old_rssi + 0.3 Ã— measured_rssi         â”‚
â”‚                                                             â”‚
â”‚ Timeout: 60 seconds (no HELLO received)                    â”‚
â”‚                                                             â”‚
â”‚ Usage:                                                      â”‚
â”‚   â€¢ Populate neighbor_rssi[] in metrics packets            â”‚
â”‚   â€¢ Shell command: "chat neighbors"                        â”‚
â”‚   â€¢ Calculate weak_node_pct                                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Key Design Decisions & Rationale

### 1. Why Separate RELAY_METRICS Packet?

**Problem:** In sequential mode, only source metrics embedded in DATA packet

**Solutions Considered:**

| Approach | Pros | Cons | Decision |
|----------|------|------|----------|
| **Embed all metrics in DATA** | Single packet | Packet size grows O(n), relay must modify packet | âŒ Not scalable |
| **Query metrics after delivery** | Flexible | Extra round trips, latency | âŒ Too slow |
| **Separate RELAY_METRICS** | Parallel delivery, fixed size | More packets | âœ… **Selected** |

**Benefits:**
- âœ… Relay nodes don't modify DATA packet (security/integrity)
- âœ… Destination receives metrics from ALL nodes (source + relays)
- âœ… Parallel transmission reduces total latency
- âœ… Fixed 48-byte packet size regardless of hop count

### 2. Why neighbor_rssi[] Array (8 entries)?

**Purpose:** Complete link quality map, not just next-hop RSSI

**Value:**
- âœ… Detect weak links (RSSI < -80 dBm) in node's neighborhood
- âœ… Calculate weak_node_pct metric for network health
- âœ… Debug routing decisions (why did it choose this path?)
- âœ… Predict node isolation before it happens

**Cost:** 24 bytes (8 Ã— 3 bytes) per metrics packet

**Trade-off:** Network visibility justifies bandwidth cost

### 3. Multi-Criteria Route Selection (70% RSSI + 30% Hop)

**Formula:** `metric = 0.7 Ã— rssi_dbm + 0.3 Ã— hop_count`

**Why not 100% RSSI?**
- May select 5-hop route with good RSSI over 2-hop route with OK RSSI
- Increases latency and congestion

**Why not 100% Hop Count?**
- May select weak link (-90 dBm) just because it's 1 hop
- High packet loss, frequent retransmissions

**Balance:** 70/30 ratio prefers good links but avoids excessive hops

### 4. Proactive (DSDV) vs Reactive (AODV) Routing

| Aspect | DSDV (This System) | AODV (Alternative) |
|--------|--------------------|--------------------|
| **Route Discovery** | Periodic (15s) | On-demand (when needed) |
| **Overhead** | Constant UPDATE traffic | Route discovery floods |
| **Latency** | Low (routes ready) | High (must discover) |
| **Best For** | Stable networks, frequent communication | Sparse networks, rare communication |

**This system chose DSDV because:**
- âœ… Chat application = frequent communication
- âœ… BLE Mesh = relatively stable topology (not mobile)
- âœ… Metrics collection = needs periodic updates anyway

## ğŸš€ Performance Characteristics

### Bandwidth Usage (per node)

```
Periodic Traffic:
  HELLO:  8 bytes Ã— 1/5s = 1.6 B/s
  UPDATE: 68 bytes Ã— 1/15s = 4.5 B/s (avg 8 routes)
          260 bytes Ã— 1/15s = 17.3 B/s (max 32 routes)
  Total: ~6 B/s baseline (typical)
         ~19 B/s (large network with 32 routes)

Data Traffic (example: 1 message/minute):
  DATA packet: 68 bytes
  RELAY_METRICS: 48 bytes Ã— (hops - 1)
  METRICS_ACK: 8 bytes
  Total per message: 124-220 bytes (2-hop to 3-hop)

Network Total (5 nodes):
  Periodic: 5 Ã— 6 = 30 B/s (typical)
  Messaging: ~4 messages/minute = 500 B/min
  Total: ~30 B/s + 8 B/s = 38 B/s average
  
Network Total (32 nodes, worst case):
  Periodic: 32 Ã— 19 = 608 B/s (all nodes send max UPDATE)
  Note: Still acceptable for BLE Mesh bandwidth (~1 KB/s typical)
```

### Memory Usage (per node)

```
RAM:
  routing_table[64]:       64 Ã— 17 B = 1088 bytes
  neighbor_rssi[16]:       16 Ã— 10 B = 160 bytes
  metrics_cache[16]:       16 Ã— 50 B = 800 bytes
  relay_cache[16]:         16 Ã— 58 B = 928 bytes
  Work queues & buffers:                ~1 KB
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total:                              ~4.0 KB

Flash:
  Code size:                         ~15-20 KB
  (Minimal embedded system footprint)
```

### Convergence Time

```
Scenario: Node fails in 3-hop network

Detection: 45s (route timeout = 3 Ã— UPDATE_INTERVAL)
Reconvergence: 15s (next UPDATE broadcast)
Total: ~60s for full network convergence

This is acceptable for:
  âœ“ Non-critical chat application
  âœ“ Occasional node failures
  âœ“ Battery-powered devices (longer intervals save power)

For critical applications:
  â€¢ Reduce UPDATE_INTERVAL to 5s
  â€¢ Reduces convergence to 20s
  â€¢ But increases bandwidth by 3Ã—
```

## ğŸ› ï¸ Shell Commands for Monitoring

```bash
# View routing table
chat routes

# View neighbor RSSI
chat neighbors

# View relay metrics cache
chat relay_metrics

# View source metrics cache  
chat metrics

# Send test message with metrics
chat send <dest_addr> <message>

# Query remote node's routing table
chat structure <dest_addr>

# Query convergence statistics
chat convergence <dest_addr>
```

## ğŸ“ˆ Example Output

### Shell: `chat relay_metrics`

```
=== RELAY NODE METRICS CACHE (3 entries) ===

[Entry 1] Relay: 0x0002 (for src=0x0001, seq=15)
  Measured: 5.2s ago, Count: 3
  +--------+---------+----------+-------+-----------+
  | Node 0x0002: Battery= 65%, Neighbors= 4, Weak=  0%, Congestion=   8â€° |
  +--------+---------+----------+-------+-----------+
  | Neighbors RSSI:                                    |
  |   â†’ 0x0001: -65 dBm                                |
  |   â†’ 0x0003: -70 dBm                                |
  |   â†’ 0x0004: -68 dBm                                |
  |   â†’ 0x0005: -75 dBm                                |
  +----------------------------------------------------+

[Entry 2] Relay: 0x0004 (for src=0x0001, seq=18)
  Measured: 12.8s ago, Count: 1
  +--------+---------+----------+-------+-----------+
  | Node 0x0004: Battery= 45%, Neighbors= 2, Weak= 50%, Congestion=   8â€° |
  +--------+---------+----------+-------+-----------+
  | Neighbors RSSI:                                    |
  |   â†’ 0x0001: -88 dBm (WEAK)                        |
  |   â†’ 0x0002: -72 dBm                                |
  +----------------------------------------------------+

[Entry 3] Relay: 0x0005 (for src=0x0003, seq=7)
  Measured: 8.5s ago, Count: 2
  +--------+---------+----------+-------+-----------+
  | Node 0x0005: Battery= 92%, Neighbors= 3, Weak=  0%, Congestion=   5â€° |
  +--------+---------+----------+-------+-----------+
  | Neighbors RSSI:                                    |
  |   â†’ 0x0002: -75 dBm                                |
  |   â†’ 0x0003: -68 dBm                                |
  |   â†’ 0x0004: -70 dBm                                |
  +----------------------------------------------------+
```

---

**Document Version:** 1.0  
**Last Updated:** 2025-11-12  
**Author:** System Analysis from chat_2 codebase
